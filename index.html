<html>
<head>
    <!--<script src="https://aframe.io/releases/0.3.0/aframe.min.js"></script>-->
    <script src="js/aframe.min.js"></script>
    <!-- <script src="https://rawgit.com/donmccurdy/aframe-extras/v2.1.1/dist/aframe-extras.loaders.min.js"></script> -->
    <script src="js/aframe-extras.loaders.min.js"></script>
    <script>

var robot_position = "box1";

// Based on "Component to change to random color on click".
AFRAME.registerComponent('cursor-listener', {
  init: function () {
    var BOXES = ['box0', 'box1', 'box2'];
    var BOX_X_POS = [-12.5, 0, 12.5];

    this.el.addEventListener('click', function (evt) {
       console.log('I was clicked at: ', evt.detail);
       console.log('target.id', evt.detail.target.id);

       if (evt.detail.target.id == robot_position) {
         weVibe.connect()
               .then(_ => {return weVibe.writeCommand(new Uint8Array([30, 32, 45, 0, 0, 0, 0, 0]));})
               //.then(_ => weVibe.disconnect())
               .catch(error => { console.log(error) });

	 var randomIndex = Math.floor(Math.random() * BOXES.length);

	 var el = document.querySelector('#the_robot');
	 el.setAttribute('position', 'x', BOX_X_POS[randomIndex]);
	 robot_position = BOXES[randomIndex];
       }
    });
  }
});
    </script>

      <script>

        // Initial class generated by: <https://beaufortfrancois.github.io/sandbox/web-bluetooth/generator/>
        // Other references:
        //  * <https://googlechrome.github.io/samples/web-bluetooth/device-info.html>
        //  * <https://googlechrome.github.io/samples/web-bluetooth/reset-energy.html>

        class WeVibe {
        
          constructor() {
            this.device = null;
            this.onDisconnected = this.onDisconnected.bind(this);
            console.log(":D");
          }
        
          request() {
            let options = {
                          "filters": [{
                "services": ["0000bb03-0000-1000-8000-00805f9b34fb"]
              }],
              "optionalServices": ["f000bb03-0451-4000-b000-000000000000"]
            };
            return navigator.bluetooth.requestDevice(options)
            .then(device => {
              this.device = device;
              this.device.addEventListener('gattserverdisconnected', this.onDisconnected);
              return device;
            });
          }
        
          connect() {
            if (!this.device) {
              return Promise.reject('Device is not connected.');
            } else {
              return this.device.gatt.connect();
              
            }
          }
          
          readInfo() {
            return this.device.gatt.getPrimaryService("f000bb03-0451-4000-b000-000000000000")
            .then(service => service.getCharacteristic("f000b000-0451-4000-b000-000000000000"))
            .then(characteristic => characteristic.readValue());
          }
          
          writeCommand(data) {
            return this.device.gatt.getPrimaryService("f000bb03-0451-4000-b000-000000000000")
            .then(service => service.getCharacteristic("f000c000-0451-4000-b000-000000000000"))
            .then(characteristic => characteristic.writeValue(data));
          }
          
          disconnect() {
            if (!this.device) {
              return Promise.reject('Device is not connected.');
            } else {
              return this.device.gatt.disconnect();
            }
          }
        
          onDisconnected() {
            console.log('Device is disconnected.');
          }
        }

        </script>

</head>
<body>
<div style="padding: 1em; position: absolute; top: 0; left 0; z-index: 10; background-color: #F0F0F0; border: 2px #992299 solid; margin: 0.5em; border-radius: 0.5em;">
<h2 style="font-family: sans-serif">Welcome to the Robot Joy Factory!</h2>
<p style="font-family: sans-serif">
  1. Enable OS Bluetooth and Location services (as necessary) and Web Bluetooth (via <code>chrome://flags</code>). 2. Then press the "Pair device" button. 3. After pairing press the "Enter VR" headset icon. 4. Enjoy!
  <div>
  <button id="btn_request_device" >
    Pair device
  </button>
  </div>
</p>
</div>
<script>
        var weVibe = new WeVibe();

        document.querySelector('#btn_request_device').addEventListener('click', function() {
          if (!navigator.bluetooth) {
            alert("No Bluetooth. :(");
            return;
          }

          // TODO: Deactive other buttons until this succeeds?
          weVibe.request();
        });
</script>

  <a-scene>
      <a-assets>
        <a-asset-item id="chr_robot" src="assets/chr_robot.bake.ply"></a-asset-item>
      </a-assets>

<a-entity camera look-controls wasd-controls position="-4 6.5 0">
  <a-entity cursor="fuse: true; fuseTimeout: 1000; objects: .clickable;"
            position="0 0 -10"
            geometry="primitive: ring"
            material="color: black; shader: flat">
  <a-animation begin="click" easing="ease-in" attribute="scale"
               fill="backwards" from="0.1 0.1 0.1" to="1 1 1"></a-animation>
  <a-animation begin="cursor-fusing" easing="ease-in" attribute="scale"
               fill="forwards" from="1 1 1" to="0.1 0.1 0.1"></a-animation>
  </a-entity>
</a-entity>

    <a-box id="box1" cursor-listener class="clickable" position="0 2.5 -17.5" rotation="0 90 0" width="5" height="5" depth="10" color="#4CC3D9"></a-box>

    <a-box id="box0" cursor-listener class="clickable" position="-12.5 2.5 -17.5" rotation="0 90 0" width="5" height="5" depth="10" color="#4CC3D9"></a-box>

    <a-box id="box2" cursor-listener class="clickable" position="12.5 2.5 -17.5" rotation="0 90 0" width="5" height="5" depth="10" color="#4CC3D9"></a-box>


    <a-entity id="the_robot" ply-model="src: #chr_robot" rotation="-90 0 0" scale="0.5 0.5 0.5" position="0 5 -17.5">
      <a-animation attribute="rotation"
		   dur="10000"
                   to="-90 360 0"
                   repeat="indefinite"></a-animation>
    </a-entity>

    <a-entity geometry="primitive: plane; height: 20; width: 40"
	      material="color: #FF44FF"
	      position="0 10 -20"
	      rotation="0 0 0"></a-entity>

    <a-entity geometry="primitive: plane; height: 20; width: 40"
	      material="color: #992299"
	      position="0 0 -10"
	      rotation="-90 0 0"
	      color="#00FF00"></a-entity>

  </a-scene>
</body>
</html>